events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Лимиты запросов
    limit_req_zone $binary_remote_addr zone=web_zone:10m rate=50r/s;
    limit_req_zone $binary_remote_addr zone=mobile_zone:10m rate=30r/s;

    # === ОСНОВНОЙ СЕРВЕР (порт 80) - проксирует на тестовые серверы ===
    server {
        listen 80;
        server_name _;

        # Web-клиенты → тестовый бэкенд на 8081
        location /api/web/ {
            limit_req zone=web_zone burst=20 nodelay;
            proxy_pass http://127.0.0.1:8081/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Client-Type "web";
        }

        # Mobile-клиенты → тестовый бэкенд на 8081
        location /api/mobile/ {
            limit_req zone=mobile_zone burst=10 nodelay;
            proxy_pass http://127.0.0.1:8081/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Client-Type "mobile";
        }

        # Все остальные /api/ запросы → тестовый бэкенд
        location /api/ {
            proxy_pass http://127.0.0.1:8081/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Корень для проверки работы
        location / {
            return 200 'NGINX работает!\nДоступные эндпоинты:\n  - /api/web/\n  - /api/mobile/\n  - /api/\n  - :8081/api/ (тестовый бэкенд)\n  - :9090/ (логистика)\n';
            add_header Content-Type text/plain;
        }
    }

    # === ТЕСТОВЫЙ СЕРВЕР 1: Имитация бэкенда приложения (порт 8081) ===
    server {
        listen 8081;
        
        location /api/ {
            add_header Content-Type application/json;
            
            if ($http_client_type = "web") {
                return 200 '{"status": "success", "service": "web_backend", "data": "Web application response"}';
            }
            if ($http_client_type = "mobile") {
                return 200 '{"status": "success", "service": "mobile_backend", "data": "Mobile application response"}';
            }
            
            return 200 '{"status": "success", "service": "default_backend", "data": "Default response"}';
        }
    }

    # === ТЕСТОВЫЙ СЕРВЕР 2: Имитация логистического сервиса (порт 9090) ===
    server {
        listen 9090;
        
        location / {
            add_header Content-Type application/json;
            
            if ($arg_type = "fast") {
                return 200 '{"status": "success", "service": "logistics", "response_time": "fast", "tracking_id": "TRK_FAST_123"}';
            }
            if ($arg_type = "slow") {
                return 200 '{"status": "slow", "service": "logistics", "response_time": "5000ms", "message": "This response is delayed"}';
            }
            if ($arg_type = "error") {
                return 500 '{"status": "error", "service": "logistics", "error_code": "INTERNAL_ERROR", "message": "Service temporarily unavailable"}';
            }
            if ($arg_type = "random") {
                return 200 '{"status": "success", "service": "logistics", "type": "random", "note": "Random behavior simulation"}';
            }
            
            return 200 '{"status": "success", "service": "logistics", "data": {"tracking_id": "TRK123456", "estimated_delivery": "2024-01-15", "status": "in_transit"}}';
        }
        
        location /fast {
            add_header Content-Type application/json;
            return 200 '{"status": "success", "endpoint": "fast", "message": "Quick response"}';
        }
        
        location /slow {
            add_header Content-Type application/json;
            return 200 '{"status": "slow", "endpoint": "slow", "message": "This is a deliberately slow response", "delay": "5000ms"}';
        }
        
        location /error {
            add_header Content-Type application/json;
            return 503 '{"status": "error", "endpoint": "error", "error": "service_unavailable", "message": "Logistics service is experiencing issues"}';
        }
        
        location /unavailable {
            add_header Content-Type application/json;
            return 500 '{"status": "error", "endpoint": "unavailable", "error": "internal_server_error"}';
        }
        
        location /random-behavior {
            add_header Content-Type application/json;
            set $last_digit 0;
            if ($remote_addr ~* ".*\.(\d)$") {
                set $last_digit $1;
            }
            
            if ($last_digit ~* "[13579]") {
                return 200 '{"status": "success", "service": "logistics", "type": "random_success", "ip_last_digit": "$last_digit"}';
            }
            if ($last_digit ~* "[24680]") {
                return 503 '{"status": "error", "service": "logistics", "type": "random_error", "ip_last_digit": "$last_digit"}';
            }
            
            return 200 '{"status": "success", "service": "logistics", "type": "default"}';
        }
    }
}